<script src="kaboom/src/kaboom.js"></script>
<script type="module">

// initialize kaboom context
const k = kaboom();

k.loadSprite("grass", "grass.png");
k.loadSprite("select", "select.png")
k.loadSprite("ritz", "ritzwalk.png", {
    sliceX: 3,
    sliceY: 4,
    anims: {
        walksw: [0, 1, 2, 1],
        walknw: [3, 4, 5, 4],
        walkse: [6, 7, 8, 7],
        walkne: [9, 10, 11, 10],
    },
});

k.loadSprite("negaritz", "negaritzwalk.png", {
    sliceX: 3,
    sliceY: 4,
    anims: {
        walksw: [0, 1, 2, 1],
        walknw: [3, 4, 5, 4],
        walkse: [6, 7, 8, 7],
        walkne: [9, 10, 11, 10],
    },
});



function tilePos(tileX, tileY) {

	return {
		movePlusX() {
			this.play("walkne");
			let oldPos = {};
			oldPos.x = (tileX*16+tileY*16)+this.spriteoffset.x;
			oldPos.y = (tileY*8-tileX*8)+this.spriteoffset.y;

			tileX += 1;
			let newPos = {};
			newPos.x = (tileX*16+tileY*16)+this.spriteoffset.x;
			newPos.y = (tileY*8-tileX*8)+this.spriteoffset.y;
			this.addTag("moveTo");
			this.oldPos = oldPos;
			this.desiredPos = newPos;
			this.moveToProgress = 0;
		},
		moveMinusX(){
			this.play("walksw");
			let oldPos = {};
			oldPos.x = (tileX*16+tileY*16)+this.spriteoffset.x;
			oldPos.y = (tileY*8-tileX*8)+this.spriteoffset.y;

			tileX -= 1;
			let newPos = {};
			newPos.x = (tileX*16+tileY*16)+this.spriteoffset.x;
			newPos.y = (tileY*8-tileX*8)+this.spriteoffset.y;
			this.addTag("moveTo");
			this.oldPos = oldPos;
			this.desiredPos = newPos;
			this.moveToProgress = 0;
		},
		movePlusY() {
			this.play("walkse");
			let oldPos = {};
			oldPos.x = (tileX*16+tileY*16)+this.spriteoffset.x;
			oldPos.y = (tileY*8-tileX*8)+this.spriteoffset.y;

			tileY += 1;
			let newPos = {};
			newPos.x = (tileX*16+tileY*16)+this.spriteoffset.x;
			newPos.y = (tileY*8-tileX*8)+this.spriteoffset.y;
			this.addTag("moveTo");
			this.oldPos = oldPos;
			this.desiredPos = newPos;
			this.moveToProgress = 0;
		},
		moveMinusY(){
			this.play("walknw");
			let oldPos = {};
			oldPos.x = (tileX*16+tileY*16)+this.spriteoffset.x;
			oldPos.y = (tileY*8-tileX*8)+this.spriteoffset.y;

			tileY -= 1;
			let newPos = {};
			newPos.x = (tileX*16+tileY*16)+this.spriteoffset.x;
			newPos.y = (tileY*8-tileX*8)+this.spriteoffset.y;
			this.addTag("moveTo");
			this.oldPos = oldPos;
			this.desiredPos = newPos;
			this.moveToProgress = 0;
		},
		center(){
			this.pos = k.vec2((tileX*16+tileY*16)+this.spriteoffset.x, (tileY*8-tileX*8)+this.spriteoffset.y);
		},
		tilePos(){
			return k.vec2(tileX, tileY);
		}

	}
}

// define a scene
k.scene("main", () => {
	k.layers([
		"bg",
		"map",
		"selector",
		"sprite",
		"ui"	
	], "sprite");

	k.camPos(k.vec2(k.width()/2, 0));

	for(var j = 0; j < 16; j++){
		for(var i = 0; i < 16; i++){
			k.add([
				k.sprite("grass", 32),
				k.pos((i*16+j*16), j*8-i*8),],
				k.layer("map")
			);	
		}
	}

	var select = k.add([
		k.sprite("select"),
		k.pos(0, 0),
		{
			spriteoffset:{x:0, y:-8}
		},
		"select"
	])


	var ritz = k.add([
		k.sprite("ritz", {animSpeed: 0.5}),
		k.pos(-1000, -1000),
		tilePos(7, 8),
		{
			spriteoffset: {x:4, y:-10},
			moveQueue:[]
		}
	]);

	ritz.center();

	var negaritz = k.add([
		k.sprite("negaritz", {animSpeed: 0.5}),
		k.pos(-1000, -1000),
		tilePos(8, 9),
		{
			spriteoffset: {x:4, y:-10},
			moveQueue:[]
		}
	]);
	negaritz.center();


	var initiative = k.add([
		"initiative",
		{
			characters : [ritz, negaritz],
			turnindex: 0,
			state: "IDLE",
			states:{
				TURN_START:"TURN_START",
				IDLE:"IDLE",
				MOVE_SELECT:"MOVE_SELECT",
				MOVING:"MOVING",
				ATTACK_SELECT:"ATTACK_SELECT",
				ATTACKING:"ATTACKING",
				TURN_END: "TURN_END"
			}
		}
	])

	k.action("initiative", (ini)=>{
		switch(ini.state){
			case "TURN_START":
				//CenterCameraOnActivePlayer
				break;
			case "IDLE":
				//showOptions(ini.characters[ini.turnindex]);
				break;
			case "MOVE_SELECT":
				//showMoveSelect();
				break;
			case "MOVING":
				break;
			case "ATTACK_SELECT":
				//showAttackSelect()
				break;
			case "ATTACKING":
				break;
			case "TURN_END":
				ini.turnindex = (ini.turnindex + 1) % ini.characters.length;
				break;

		}


	})


	



	k.action("select", (s) => {
		let spriteoffset = s.spriteoffset;
		let pos = k.mousePos().sub(0, 8*30);
		s.tpos = k.vec2(Math.floor(1/32*(pos.x-2*pos.y)), Math.floor(1/32*(pos.x+2*pos.y)));
		s.pos = k.vec2((s.tpos.x*16+s.tpos.y*16)+spriteoffset.x, (s.tpos.y*8-s.tpos.x*8)+spriteoffset.y)
		//mouseTile(s, k.mousePos());
	})

	k.action("moveTo", (s) => {
		if(s.moveToProgress > 1){
			s.removeTag("moveTo");
			s.center();
			s.addTag("moveEnd");
			return;
		}
		s.moveToProgress += 0.1;
		let xPos = s.oldPos.x + (s.desiredPos.x - s.oldPos.x) * s.moveToProgress;
		let yPos = s.oldPos.y + (s.desiredPos.y - s.oldPos.y) * s.moveToProgress;
		s.pos = k.vec2(xPos, yPos);
	});

	k.action("moveEnd", (s) => {
		s.removeTag("moveEnd");
		if(s.moveQueue.length==0){
			return;
		}
		s.addTag("moveStart");

	});

	k.action("moveStart", (s)=>{
		s.removeTag("moveStart");
		if(s.moveQueue.length == 0){
			return;
		}
		let dir = s.moveQueue.shift()
		if(dir.x == -1 && dir.y == 0){
			s.moveMinusX();
		}
		if(dir.x == 1 && dir.y == 0){
			s.movePlusX();
		}
		if(dir.x == 0 && dir.y == -1){
			s.moveMinusY();
		}
		if(dir.x == 0 && dir.y == 1){
			s.movePlusY();
		}
		s.removeTag("moveStart");
	})

	k.mouseClick(() => {
		let selectorPos = select.tpos.add(k.vec2(1, -1));
		let pPos = ritz.tilePos();

		let delta = selectorPos.sub(pPos);
		let len = Math.abs(delta.x)+Math.abs(delta.y);
		for(var i = 0; i < len; i++){
			if(delta.x > 0){
				delta.x -= 1;
				ritz.moveQueue.push({x:1, y:0})
				continue;
			}
			if(delta.x < 0){
				delta.x += 1;
				ritz.moveQueue.push({x:-1, y:0})
				continue;
			}
			if(delta.y < 0){
				delta.y += 1;
				ritz.moveQueue.push({x:0, y:-1})
				continue;
			}
			if(delta.y > 0){
				delta.y -= 1;
				ritz.moveQueue.push({x:0, y:1})
				continue;
			}
		}
		ritz.addTag("moveStart");


	})

});



// start the game
k.start("main");

</script>