<script src="kaboom/src/kaboom.js"></script>
<script type="module">

// initialize kaboom context
const k = kaboom();

k.loadSprite("grass", "grass.png");
k.loadSprite("select", "select.png")
k.loadSprite("ritz", "ritzwalk.png", {
    sliceX: 3,
    sliceY: 4,
    anims: {
        walksw: [0, 1, 2, 1],
        walknw: [3, 4, 5, 4],
        walkse: [6, 7, 8, 7],
        walkne: [9, 10, 11, 10],
    },
});

// function mouseTile(s, mousePos){
// 	const camPos = {x: -5, y: -5, z: -5}
//  	const camDirection = { x: 1, y:1, z:1}
//  	const touch = {x: mousePos.x, y:-mousePos.y}
//  	const sqrt2 = Math.sqrt(2);
//  	const spriteoffset = {x:0, y:8};

//  	const touchPos = {
//  		x: camPos.x + touch.x / sqrt2,
//  		y: camPos.y - touch.x / sqrt2,
//  		z: camPos.z - touch.y / sqrt2
//  	}

//  	for(let delta = 0; delta < 100; delta++){
//  		const x = touchPos.x + camDirection.x * delta;
//  		const y = touchPos.y + camDirection.y * delta;
//  		const z = touchPos.z + camDirection.z * delta;
//  		const absX = ~~(x/16);
//  		const absZ = ~~(z/16);
//  		//console.log(absX, absZ)

//  		if(0 >= y){
//  			s.pos = k.vec2((absX*16+absZ*16)+spriteoffset.x, (absZ*8-absX*8)+spriteoffset.y)
//  		}


//  	}

// }

function tilePos(tileX, tileY) {
	var spriteoffset = {x:4, y:-10};
	return {
		movePlusX() {
			this.play("walkne");
			let oldPos = {};
			oldPos.x = (tileX*16+tileY*16)+spriteoffset.x;
			oldPos.y = (tileY*8-tileX*8)+spriteoffset.y;

			tileX += 1;
			let newPos = {};
			newPos.x = (tileX*16+tileY*16)+spriteoffset.x;
			newPos.y = (tileY*8-tileX*8)+spriteoffset.y;
			this.addTag("moveTo");
			this.oldPos = oldPos;
			this.desiredPos = newPos;
			this.moveToProgress = 0;
		},
		moveMinusX(){
			this.play("walksw");
			let oldPos = {};
			oldPos.x = (tileX*16+tileY*16)+spriteoffset.x;
			oldPos.y = (tileY*8-tileX*8)+spriteoffset.y;

			tileX -= 1;
			let newPos = {};
			newPos.x = (tileX*16+tileY*16)+spriteoffset.x;
			newPos.y = (tileY*8-tileX*8)+spriteoffset.y;
			this.addTag("moveTo");
			this.oldPos = oldPos;
			this.desiredPos = newPos;
			this.moveToProgress = 0;
		},
		movePlusY() {
			this.play("walkse");
			let oldPos = {};
			oldPos.x = (tileX*16+tileY*16)+spriteoffset.x;
			oldPos.y = (tileY*8-tileX*8)+spriteoffset.y;

			tileY += 1;
			let newPos = {};
			newPos.x = (tileX*16+tileY*16)+spriteoffset.x;
			newPos.y = (tileY*8-tileX*8)+spriteoffset.y;
			this.addTag("moveTo");
			this.oldPos = oldPos;
			this.desiredPos = newPos;
			this.moveToProgress = 0;
		},
		moveMinusY(){
			this.play("walknw");
			let oldPos = {};
			oldPos.x = (tileX*16+tileY*16)+spriteoffset.x;
			oldPos.y = (tileY*8-tileX*8)+spriteoffset.y;

			tileY -= 1;
			let newPos = {};
			newPos.x = (tileX*16+tileY*16)+spriteoffset.x;
			newPos.y = (tileY*8-tileX*8)+spriteoffset.y;
			this.addTag("moveTo");
			this.oldPos = oldPos;
			this.desiredPos = newPos;
			this.moveToProgress = 0;
		},
		center(){
			this.pos = k.vec2((tileX*16+tileY*16)+spriteoffset.x, (tileY*8-tileX*8)+spriteoffset.y);
		},
		tilePos(){
			return k.vec2(tileX, tileY);
		}

	}
}

// define a scene
k.scene("main", () => {
	k.camPos(k.vec2(k.width()/2, 0));
	for(var j = 0; j < 16; j++){
		for(var i = 0; i < 16; i++){
			k.add([
				k.sprite("grass", 32),
				k.pos((i*16+j*16), j*8-i*8),]
			);	
		}
		
	}
	var spriteoffset = {x:4, y:-10};
	let tilex = 7;
	let tiley = 8;

	var ritz = k.add([
		k.sprite("ritz", {
        animSpeed: 0.5}),
		k.pos((tilex*16+tiley*16)+spriteoffset.x, (tiley*8-tilex*8)+spriteoffset.y),
		tilePos(tilex, tiley),
		{
			moveQueue:[]
		}
	])

	

	

	ritz.moveMinusX();

	var select = k.add([
		k.sprite("select"),
		k.pos(0, 0),
		"select"
	])

	k.action("select", (s) => {
		let spriteoffset = {x:0, y:-8};
		let pos = k.mousePos().sub(0, 8*30);
		s.tpos = k.vec2(Math.floor(1/32*(pos.x-2*pos.y)), Math.floor(1/32*(pos.x+2*pos.y)));
		s.pos = k.vec2((s.tpos.x*16+s.tpos.y*16)+spriteoffset.x, (s.tpos.y*8-s.tpos.x*8)+spriteoffset.y)
		//mouseTile(s, k.mousePos());
	})

	k.action("moveTo", (s) => {
		if(s.moveToProgress > 1){
			s.removeTag("moveTo");
			s.center();
			s.addTag("moveEnd");
			return;
		}
		s.moveToProgress += 0.1;
		let xPos = s.oldPos.x + (s.desiredPos.x - s.oldPos.x) * s.moveToProgress;
		let yPos = s.oldPos.y + (s.desiredPos.y - s.oldPos.y) * s.moveToProgress;
		s.pos = k.vec2(xPos, yPos);
	});

	k.action("moveEnd", (s) => {
		s.removeTag("moveEnd");
		if(s.moveQueue.length==0){
			return;
		}
		s.addTag("moveStart");

	});

	k.action("moveStart", (s)=>{
		s.removeTag("moveStart");
		if(s.moveQueue.length == 0){
			return;
		}
		let dir = s.moveQueue.shift()
		if(dir.x == -1 && dir.y == 0){
			s.moveMinusX();
		}
		if(dir.x == 1 && dir.y == 0){
			s.movePlusX();
		}
		if(dir.x == 0 && dir.y == -1){
			s.moveMinusY();
		}
		if(dir.x == 0 && dir.y == 1){
			s.movePlusY();
		}
		s.removeTag("moveStart");
	})

	k.mouseClick(() => {
		let selectorPos = select.tpos.add(k.vec2(1, -1));
		let pPos = ritz.tilePos();

		let delta = selectorPos.sub(pPos);
		let len = Math.abs(delta.x)+Math.abs(delta.y);
		for(var i = 0; i < len; i++){
			if(delta.x > 0){
				delta.x -= 1;
				ritz.moveQueue.push({x:1, y:0})
				continue;
			}
			if(delta.x < 0){
				delta.x += 1;
				ritz.moveQueue.push({x:-1, y:0})
				continue;
			}
			if(delta.y < 0){
				delta.y += 1;
				ritz.moveQueue.push({x:0, y:-1})
				continue;
			}
			if(delta.y > 0){
				delta.y -= 1;
				ritz.moveQueue.push({x:0, y:1})
				continue;
			}
		}
		ritz.addTag("moveStart");


	})
	
	// k.mouseClick(() => {
	// 	var pos = k.mousePos();
	// 	//var center = k.vec2(width()/2, height()/2)
	// 	k.camPos(pos);
	// });

});



// start the game
k.start("main");

</script>